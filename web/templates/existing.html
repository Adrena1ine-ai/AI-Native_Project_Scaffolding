{% extends "base.html" %}

{% block title %}{{ t.get('nav_existing', 'Existing Project') }} ‚Äî AI Toolkit{% endblock %}

{% block content %}
<div class="page-header">
    <span class="page-title-icon">üìÇ</span>
    <h1 class="page-title">{{ t.get('existing_title', 'Work with Existing Project') }}</h1>
    <p class="page-subtitle">{{ t.get('existing_subtitle', 'Select a project folder, detect IDE configs, and apply manifesto rules') }}</p>
</div>

<div class="card" id="main-form">
    <!-- Step 1: Select Project Path -->
    <div id="step1">
        <h3 style="margin-bottom: 1.5rem;">üìÅ {{ t.get('existing_step1', 'Step 1: Select Project Folder') }}</h3>
        
        <div class="form-group">
            <label class="form-label">{{ t.get('existing_path', 'Project Path') }}</label>
            <input type="text" class="form-input" id="project-path" 
                   placeholder="/home/user/projects/my_project" 
                   value="{{ home_path }}">
            <p class="form-hint">{{ t.get('existing_path_hint', 'Enter the full path to your existing project') }}</p>
        </div>
        
        <button class="btn btn-primary btn-block" onclick="scanProject()">
            üîç {{ t.get('existing_scan', 'Scan Project') }}
        </button>
        
        <div class="loader" id="scan-loader">
            <div class="spinner"></div>
            <span>{{ t.get('existing_scanning', 'Scanning project...') }}</span>
        </div>
    </div>
    
    <!-- Step 2: Detected IDEs (hidden initially) -->
    <div id="step2" class="hidden" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">üñ•Ô∏è {{ t.get('existing_step2', 'Step 2: Detected IDE Configs') }}</h3>
        
        <div class="alert alert-info" id="project-info">
            <span class="alert-icon">üìÅ</span>
            <span>Project: <strong id="project-name"></strong></span>
        </div>
        
        <p style="margin-bottom: 1rem; color: var(--text-secondary);">
            {{ t.get('existing_ide_hint', 'Select which IDEs you want to configure for this project:') }}
        </p>
        
        <div class="checkbox-group" id="ide-checkboxes">
            <label class="checkbox-item">
                <input type="checkbox" id="ide-cursor" checked>
                <span>üíú Cursor</span>
                <span id="ide-cursor-status" style="margin-left: auto; font-size: 0.85rem;"></span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" id="ide-copilot" checked>
                <span>üíô GitHub Copilot</span>
                <span id="ide-copilot-status" style="margin-left: auto; font-size: 0.85rem;"></span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" id="ide-claude" checked>
                <span>üü¢ Claude</span>
                <span id="ide-claude-status" style="margin-left: auto; font-size: 0.85rem;"></span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" id="ide-windsurf" checked>
                <span>üåä Windsurf</span>
                <span id="ide-windsurf-status" style="margin-left: auto; font-size: 0.85rem;"></span>
            </label>
        </div>
    </div>
    
    <!-- Step 3: Issues Found (hidden initially) -->
    <div id="step3" class="hidden" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">‚ö†Ô∏è {{ t.get('existing_step3', 'Step 3: Issues Found') }}</h3>
        
        <div class="issue-list" id="issues-list"></div>
    </div>
    
    <!-- Step 4: Actions (hidden initially) -->
    <div id="step4" class="hidden" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">üõ†Ô∏è {{ t.get('existing_step4', 'Step 4: Available Actions') }}</h3>
        
        <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <button class="btn btn-success btn-block" onclick="applyManifesto()">
                üìú {{ t.get('existing_apply_manifesto', 'Apply Manifesto') }}
            </button>
            <button class="btn btn-primary btn-block" onclick="migrateProject()">
                üì¶ {{ t.get('existing_migrate', 'Migrate') }}
            </button>
            <button class="btn btn-warning btn-block" onclick="cleanupProject()">
                üßπ {{ t.get('existing_cleanup', 'Cleanup') }}
            </button>
            <button class="btn btn-outline btn-block" onclick="healthCheck()">
                üè• {{ t.get('existing_health', 'Health Check') }}
            </button>
        </div>
        
        <div class="loader" id="action-loader" style="margin-top: 1rem;">
            <div class="spinner"></div>
            <span>{{ t.get('existing_processing', 'Processing...') }}</span>
        </div>
    </div>
    
    <!-- Results (hidden initially) -->
    <div id="results" class="hidden" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1rem;">üìã {{ t.get('existing_results', 'Results') }}</h3>
        <div class="output-box" id="results-output"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentProjectPath = '';
    let detectedIdes = {};
    
    async function scanProject() {
        const pathInput = document.getElementById('project-path');
        const path = pathInput.value.trim();
        
        if (!path) {
            showAlert(document.getElementById('main-form'), 'error', '{{ t.get("existing_error_path", "Please enter project path") }}');
            return;
        }
        
        currentProjectPath = path;
        
        // Show loader
        document.getElementById('scan-loader').classList.add('active');
        
        try {
            // Detect IDEs
            const ideResult = await apiCall('/api/detect-ides', { path });
            
            if (!ideResult.success) {
                throw new Error(ideResult.message);
            }
            
            detectedIdes = ideResult.detected_ides;
            
            // Update IDE checkboxes with detection status
            document.getElementById('project-name').textContent = ideResult.project_name;
            
            for (const [ide, detected] of Object.entries(detectedIdes)) {
                const checkbox = document.getElementById(`ide-${ide}`);
                const status = document.getElementById(`ide-${ide}-status`);
                
                if (detected) {
                    checkbox.checked = true;
                    status.innerHTML = '<span style="color: var(--accent-green);">‚úÖ Detected</span>';
                } else {
                    checkbox.checked = true; // Still check by default
                    status.innerHTML = '<span style="color: var(--text-muted);">‚Äî Not found</span>';
                }
            }
            
            // Show step 2
            document.getElementById('step2').classList.remove('hidden');
            
            // Analyze project for issues
            const analyzeResult = await apiCall('/api/analyze', { path });
            
            if (analyzeResult.success && analyzeResult.issues_count > 0) {
                const issuesList = document.getElementById('issues-list');
                issuesList.innerHTML = analyzeResult.issues.map(issue => {
                    const icons = { error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
                    return `
                        <div class="issue-item ${issue.severity}">
                            <span class="issue-icon">${icons[issue.severity] || '‚ÑπÔ∏è'}</span>
                            <span class="issue-text">${issue.message}</span>
                            ${issue.size_mb > 0 ? `<span class="issue-size">${issue.size_mb} MB</span>` : ''}
                        </div>
                    `;
                }).join('');
                
                document.getElementById('step3').classList.remove('hidden');
            }
            
            // Show step 4
            document.getElementById('step4').classList.remove('hidden');
            
        } catch (error) {
            showAlert(document.getElementById('main-form'), 'error', error.message);
        } finally {
            document.getElementById('scan-loader').classList.remove('active');
        }
    }
    
    function getSelectedIdes() {
        const selected = [];
        if (document.getElementById('ide-cursor').checked) selected.push('cursor');
        if (document.getElementById('ide-copilot').checked) selected.push('copilot');
        if (document.getElementById('ide-claude').checked) selected.push('claude');
        if (document.getElementById('ide-windsurf').checked) selected.push('windsurf');
        return selected;
    }
    
    async function applyManifesto() {
        const loader = document.getElementById('action-loader');
        loader.classList.add('active');
        
        try {
            const result = await apiCall('/api/apply-manifesto', { 
                path: currentProjectPath,
                ides: getSelectedIdes()
            });
            
            if (result.success) {
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('results-output').textContent = JSON.stringify(result.applied_files, null, 2);
                showAlert(document.getElementById('main-form'), 'success', '{{ t.get("existing_manifesto_applied", "Manifesto rules applied!") }}');
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            showAlert(document.getElementById('main-form'), 'error', error.message);
        } finally {
            loader.classList.remove('active');
        }
    }
    
    async function migrateProject() {
        const loader = document.getElementById('action-loader');
        loader.classList.add('active');
        
        try {
            const result = await apiCall('/api/migrate', { path: currentProjectPath });
            
            if (result.success) {
                showAlert(document.getElementById('main-form'), 'success', result.message);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            showAlert(document.getElementById('main-form'), 'error', error.message);
        } finally {
            loader.classList.remove('active');
        }
    }
    
    async function cleanupProject() {
        const loader = document.getElementById('action-loader');
        loader.classList.add('active');
        
        try {
            const result = await apiCall('/api/cleanup', { 
                path: currentProjectPath,
                level: 'medium'
            });
            
            if (result.success) {
                showAlert(document.getElementById('main-form'), 'success', result.message);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            showAlert(document.getElementById('main-form'), 'error', error.message);
        } finally {
            loader.classList.remove('active');
        }
    }
    
    async function healthCheck() {
        const loader = document.getElementById('action-loader');
        loader.classList.add('active');
        
        try {
            const result = await apiCall('/api/health', { path: currentProjectPath });
            
            if (result.success) {
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('results-output').textContent = result.output;
                showAlert(document.getElementById('main-form'), result.passed ? 'success' : 'warning', 
                    result.passed ? '{{ t.get("existing_health_passed", "Health check passed!") }}' : '{{ t.get("existing_health_issues", "Health check found issues") }}');
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            showAlert(document.getElementById('main-form'), 'error', error.message);
        } finally {
            loader.classList.remove('active');
        }
    }
</script>
{% endblock %}

