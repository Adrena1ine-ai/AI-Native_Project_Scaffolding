{% extends "base.html" %}

{% block title %}–û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî AI Toolkit{% endblock %}

{% block content %}
<div class="page-header">
    <span class="page-title-icon">üßπ</span>
    <h1 class="page-title">–û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</h1>
    <p class="page-subtitle">
        –ù–∞–π–¥–∏ –∏ –∏—Å–ø—Ä–∞–≤—å –ø—Ä–æ–±–ª–µ–º—ã: venv –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞, –±–æ–ª—å—à–∏–µ –ª–æ–≥–∏, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏
    </p>
</div>

<div class="card" style="max-width: 900px; margin: 0 auto;">
    <!-- –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É -->
    <div class="form-group">
        <label class="form-label">üìç –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É</label>
        <div style="display: flex; gap: 1rem;">
            <input type="text" class="form-input" id="projectPath"
                   placeholder="{{ home_path }}/my_project" style="flex: 1;">
            <button class="btn btn-primary" onclick="analyze()">
                üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
    </div>
    
    <!-- –õ–æ–∞–¥–µ—Ä -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç...</span>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
    <div id="analysisResult" class="hidden" style="margin-top: 2rem;"></div>
    
    <!-- –£—Ä–æ–≤–Ω–∏ –æ—á–∏—Å—Ç–∫–∏ -->
    <div id="cleanupOptions" class="hidden" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1rem;">üßπ –í—ã–±–µ—Ä–∏ —É—Ä–æ–≤–µ–Ω—å –æ—á–∏—Å—Ç–∫–∏</h3>
        
        <div class="radio-cards" style="grid-template-columns: repeat(3, 1fr);">
            {% for key, level in cleanup_levels.items() %}
            <label class="radio-card">
                <input type="radio" name="level" value="{{ key }}"
                       {% if key == 'safe' %}checked{% endif %}>
                <div class="radio-card-content">
                    <span class="radio-card-icon">
                        {% if key == 'safe' %}üîí{% elif key == 'medium' %}‚ö°{% else %}üî•{% endif %}
                    </span>
                    <span class="radio-card-title">{{ level.name }}</span>
                    <span class="radio-card-desc">{{ level.description }}</span>
                </div>
            </label>
            {% endfor %}
        </div>
        
        <button class="btn btn-warning btn-lg btn-block" style="margin-top: 1.5rem;" onclick="cleanup()">
            üßπ –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É
        </button>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏ -->
    <div id="cleanupResult" class="hidden" style="margin-top: 2rem;"></div>
</div>

<!-- –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è -->
<div class="card" style="max-width: 900px; margin: 2rem auto;">
    <h3 style="margin-bottom: 1rem;">‚ÑπÔ∏è –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è?</h3>
    
    <div class="issue-list">
        <div class="issue-item error">
            <span class="issue-icon">‚ùå</span>
            <span class="issue-text"><strong>venv –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞</strong> ‚Äî AI –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç 500MB –º—É—Å–æ—Ä–∞</span>
        </div>
        <div class="issue-item error">
            <span class="issue-icon">‚ùå</span>
            <span class="issue-text"><strong>site-packages</strong> ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ä–µ–ø–æ</span>
        </div>
        <div class="issue-item warning">
            <span class="issue-icon">‚ö†Ô∏è</span>
            <span class="issue-text"><strong>–ë–æ–ª—å—à–∏–µ –ª–æ–≥–∏ (>10MB)</strong> ‚Äî —Ç–æ—Ä–º–æ–∑—è—Ç IDE</span>
        </div>
        <div class="issue-item warning">
            <span class="issue-icon">‚ö†Ô∏è</span>
            <span class="issue-text"><strong>–ë–æ–ª—å—à–∞—è –ø–∞–ø–∫–∞ data/</strong> ‚Äî –ª—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ</span>
        </div>
        <div class="issue-item info">
            <span class="issue-icon">‚ÑπÔ∏è</span>
            <span class="issue-text"><strong>__pycache__</strong> ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å</span>
        </div>
        <div class="issue-item warning">
            <span class="issue-icon">‚ö†Ô∏è</span>
            <span class="issue-text"><strong>–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–Ω—Ñ–∏–≥–∏</strong> ‚Äî _AI_INCLUDE, .cursorignore</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const loader = document.getElementById('loader');
    const analysisResult = document.getElementById('analysisResult');
    const cleanupOptions = document.getElementById('cleanupOptions');
    const cleanupResult = document.getElementById('cleanupResult');
    
    async function analyze() {
        const path = document.getElementById('projectPath').value;
        if (!path) {
            alert('–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É');
            return;
        }
        
        loader.classList.add('active');
        analysisResult.classList.add('hidden');
        cleanupOptions.classList.add('hidden');
        cleanupResult.classList.add('hidden');
        
        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            });
            
            const data = await response.json();
            
            if (data.success) {
                if (data.issues_count === 0) {
                    analysisResult.innerHTML = `
                        <div class="alert alert-success">
                            <span class="alert-icon">‚úÖ</span>
                            <span><strong>${data.project_name}</strong> ‚Äî –ø—Ä–æ–µ–∫—Ç —á–∏—Å—Ç—ã–π! –ü—Ä–æ–±–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</span>
                        </div>
                    `;
                } else {
                    const severityIcons = { error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
                    
                    analysisResult.innerHTML = `
                        <div class="alert alert-warning">
                            <span class="alert-icon">üîç</span>
                            <span>–ù–∞–π–¥–µ–Ω–æ ${data.issues_count} –ø—Ä–æ–±–ª–µ–º(—ã) –≤ <strong>${data.project_name}</strong></span>
                        </div>
                        
                        <div class="issue-list">
                            ${data.issues.map(issue => `
                                <div class="issue-item ${issue.severity}">
                                    <span class="issue-icon">${severityIcons[issue.severity]}</span>
                                    <span class="issue-text">${issue.message}</span>
                                    ${issue.size_mb > 0 ? `<span class="issue-size">${issue.size_mb} MB</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    cleanupOptions.classList.remove('hidden');
                }
            } else {
                analysisResult.innerHTML = `
                    <div class="alert alert-error">
                        <span class="alert-icon">‚ùå</span>
                        <span>${data.message}</span>
                    </div>
                `;
            }
            
        } catch (error) {
            analysisResult.innerHTML = `
                <div class="alert alert-error">
                    <span class="alert-icon">‚ùå</span>
                    <span>–û—à–∏–±–∫–∞: ${error.message}</span>
                </div>
            `;
        }
        
        loader.classList.remove('active');
        analysisResult.classList.remove('hidden');
    }
    
    async function cleanup() {
        const path = document.getElementById('projectPath').value;
        const level = document.querySelector('input[name="level"]:checked').value;
        
        if (level !== 'safe' && !confirm(`–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É —É—Ä–æ–≤–Ω—è "${level}"? –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø.`)) {
            return;
        }
        
        loader.classList.add('active');
        cleanupResult.classList.add('hidden');
        
        try {
            const response = await fetch('/api/cleanup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path, level })
            });
            
            const data = await response.json();
            
            if (data.success) {
                cleanupResult.innerHTML = `
                    <div class="alert alert-success">
                        <span class="alert-icon">‚úÖ</span>
                        <span>${data.message}</span>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="analyze()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
            } else {
                cleanupResult.innerHTML = `
                    <div class="alert alert-error">
                        <span class="alert-icon">‚ùå</span>
                        <span>${data.message}</span>
                    </div>
                `;
            }
            
        } catch (error) {
            cleanupResult.innerHTML = `
                <div class="alert alert-error">
                    <span class="alert-icon">‚ùå</span>
                    <span>–û—à–∏–±–∫–∞: ${error.message}</span>
                </div>
            `;
        }
        
        loader.classList.remove('active');
        cleanupResult.classList.remove('hidden');
    }
</script>
{% endblock %}

