import os
import shutil
import re
from pathlib import Path
import logging

def setup_logger():
    logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')
    return logging.getLogger("Architect")

logger = setup_logger()

def create_config_paths(target_path, project_name):
    """–í–Ω–µ–¥—Ä—è–µ—Ç config_paths.py –≤ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–æ–µ–∫—Ç"""
    config_content = f'''import os
from pathlib import Path

# === AI-NATIVE PATH CONFIGURATION ===
# Auto-generated by AI-Native Toolkit

BASE_DIR = Path(__file__).resolve().parent
PROJECT_NAME = "{project_name}"
EXTERNAL_ROOT = BASE_DIR.parent

# 1. DATA (JSON, DB, CSV)
DATA_DIR = EXTERNAL_ROOT / "_data" / PROJECT_NAME
if not DATA_DIR.exists():
    DATA_DIR = BASE_DIR / "data"

# 2. LOGS
LOGS_DIR = EXTERNAL_ROOT / "_logs" / PROJECT_NAME
if not LOGS_DIR.exists():
    LOGS_DIR = BASE_DIR / "logs"

# 3. VENV (Reference only)
VENV_DIR = EXTERNAL_ROOT / "_venvs" / PROJECT_NAME

def get_path(filename, check_exists=False):
    """Smart path resolver: External > Internal"""
    external_path = DATA_DIR / filename
    local_path = BASE_DIR / filename
    
    if check_exists:
        if external_path.exists(): return external_path
        if local_path.exists(): return local_path
    
    return external_path
'''
    config_path = Path(target_path) / "config_paths.py"
    try:
        with open(config_path, "w", encoding="utf-8") as f:
            f.write(config_content)
        logger.info(f"‚úÖ [Bridge] Created {config_path.name}")
        return True
    except Exception as e:
        logger.error(f"‚ùå Failed to create config: {e}")
        return False

def restructure_project(target_path):
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞"""
    target = Path(target_path).resolve()
    project_name = target.name
    parent_dir = target.parent

    # –ù–æ–≤—ã–µ –ª–æ–∫–∞—Ü–∏–∏
    new_dirs = {
        "venv": parent_dir / "_venvs" / project_name,
        "data": parent_dir / "_data" / project_name,
        "logs": parent_dir / "_logs" / project_name
    }

    print(f"\nüèóÔ∏è  ARCHITECT: Restructuring {project_name}...")

    # 1. –°–æ–∑–¥–∞–µ–º –º–æ—Å—Ç
    create_config_paths(target, project_name)

    # 2. –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Ñ–∞–π–ª—ã
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ _data
    data_patterns = ["*.json", "*.csv", "*.db", "*.sqlite", "*.sqlite3"]
    
    for folder_type, dest_path in new_dirs.items():
        dest_path.mkdir(parents=True, exist_ok=True)

    # === –ü–ï–†–ï–ù–û–° –¢–Ø–ñ–ï–õ–´–• –ü–ê–ü–û–ö (–í–∫–ª—é—á–∞—è venv_gate) ===
    # –°–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å—á–∏—Ç–∞–µ–º "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º"
    venv_names = ["venv", ".venv", "venv_gate", "env"]
    
    for v_name in venv_names:
        old_venv = target / v_name
        if old_venv.exists() and old_venv.is_dir():
            print(f"üì¶ Found heavy folder: {v_name}")
            try:
                # –ü–µ—Ä–µ–º–µ—â–∞–µ–º. –ï—Å–ª–∏ –≤ _venvs —É–∂–µ –µ—Å—Ç—å –ø–∞–ø–∫–∞, shutil.move –∫–∏–Ω–µ—Ç –æ—à–∏–±–∫—É,
                # –ø–æ—ç—Ç–æ–º—É –ª—É—á—à–µ —Å–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —Ç–∞–º, –µ—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å.
                if new_dirs["venv"].exists():
                    shutil.rmtree(new_dirs["venv"])
                
                print(f"üì¶ Moving {v_name} -> {new_dirs['venv']}...")
                shutil.move(str(old_venv), str(new_dirs["venv"]))
            except Exception as e:
                print(f"‚ö†Ô∏è Could not move {v_name}: {e}")

    # –ü–µ—Ä–µ–Ω–æ—Å –ª–æ–≥–æ–≤
    for log_file in target.glob("*.log"):
        try:
            shutil.move(str(log_file), str(new_dirs["logs"] / log_file.name))
        except Exception as e:
            print(f"‚ö†Ô∏è Could not move log {log_file.name}: {e}")
    
    if (target / "_PROJECT_LOG.md").exists():
        try:
            shutil.move(str(target / "_PROJECT_LOG.md"), str(new_dirs["logs"] / "_PROJECT_LOG.md"))
        except Exception as e:
            print(f"‚ö†Ô∏è Could not move _PROJECT_LOG.md: {e}")

    # –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö (JSON, DB)
    for pattern in data_patterns:
        for f in target.glob(pattern):
            if f.name == "config_paths.py": continue # –ù–µ —Ç—Ä–æ–≥–∞–µ–º –Ω–∞—à –∫–æ–Ω—Ñ–∏–≥
            if "package" in str(f): continue # –ù–µ —Ç—Ä–æ–≥–∞–µ–º —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ –ª–∏–±
            
            dest = new_dirs["data"] / f.name
            print(f"üì¶ Moving data {f.name} -> {dest}")
            try:
                shutil.move(str(f), str(dest))
            except Exception as e:
                print(f"‚ö†Ô∏è Could not move data {f.name}: {e}")

    # 3. –ü–∞—Ç—á–∏–Ω–≥ .bat —Ñ–∞–π–ª–æ–≤
    fix_launch_scripts(target, project_name)
    
    # 4. –ß–∏—Å—Ç–∫–∞ .cursorignore
    update_cursor_ignore(target)

    print(f"‚ú® Architecture updated! Dependencies are now external.")

def fix_launch_scripts(target_path, project_name):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞—Ç–Ω–∏–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ venv"""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—ã—Ä—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø—É—Ç–∏ –∫ python
    # –í–∞–∂–Ω–æ: –¥–ª—è regex –∑–∞–º–µ–Ω—ã –º—ã –¥–æ–ª–∂–Ω—ã —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –±—ç–∫—Å–ª–µ—à–∏
    
    # –ü—É—Ç—å –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ö–æ—Ç–∏–º –≤–∏–¥–µ—Ç—å –≤ –±–∞—Ç–Ω–∏–∫–µ: ..\_venvs\Name\Scripts\python.exe
    rel_python_path = f'..\\_venvs\\{project_name}\\Scripts\\python.exe'
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –≤—ã–∑–æ–≤–∞. –í bat —Ñ–∞–π–ª–µ —ç—Ç–æ call "..."
    new_call_cmd = f'call "{rel_python_path}"'

    for bat in Path(target_path).glob("*.bat"):
        try:
            content = bat.read_text(encoding="utf-8", errors="ignore")
            
            # 1. –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é venv
            # –ò—â–µ–º call ...activate
            content = re.sub(r'(?i)(call\s+.*?activate)', r'REM \1', content)

            # 2. –ó–∞–º–µ–Ω—è–µ–º python main.py –Ω–∞ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
            # –ò—â–µ–º "python main.py" –∏–ª–∏ "python bot.py"
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º lambda, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å backslash –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–º–µ–Ω—ã
            content = re.sub(
                r'(?i)python\s+(.*?\.py)', 
                lambda m: f'{new_call_cmd} {m.group(1)}', 
                content
            )
            
            bat.write_text(content, encoding="utf-8")
            print(f"üîß Patched launch script: {bat.name}")
        except Exception as e:
            print(f"‚ö†Ô∏è Failed to patch {bat.name}: {e}")

def update_cursor_ignore(target_path):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–≥–Ω–æ—Ä –ª–∏—Å—Ç"""
    ignore_file = Path(target_path) / ".cursorignore"
    content = """# AI-Native Architecture
# Data and Env are external

_venvs/
_data/
_logs/
venv/
venv_gate/
.venv/
__pycache__/
*.pyc
"""
    try:
        ignore_file.write_text(content, encoding="utf-8")
        print("üßπ Updated .cursorignore")
    except Exception as e:
        print(f"‚ö†Ô∏è Failed to update .cursorignore: {e}")

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è main.py
def run(args):
    restructure_project(args.path)
