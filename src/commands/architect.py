import os
import shutil
import re
from pathlib import Path
import logging

def setup_logger():
    logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')
    return logging.getLogger("Architect")

logger = setup_logger()

def create_config_paths(target_path, project_name):
    """–í–Ω–µ–¥—Ä—è–µ—Ç config_paths.py –≤ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–æ–µ–∫—Ç"""
    config_content = f'''import os
from pathlib import Path

# === AI-NATIVE PATH CONFIGURATION ===
# Auto-generated by AI-Native Toolkit

BASE_DIR = Path(__file__).resolve().parent
PROJECT_NAME = "{project_name}"
EXTERNAL_ROOT = BASE_DIR.parent

# 1. DATA (JSON, DB, CSV)
DATA_DIR = EXTERNAL_ROOT / "_data" / PROJECT_NAME
if not DATA_DIR.exists():
    DATA_DIR = BASE_DIR / "data"

# 2. LOGS
LOGS_DIR = EXTERNAL_ROOT / "_logs" / PROJECT_NAME
if not LOGS_DIR.exists():
    LOGS_DIR = BASE_DIR / "logs"

# 3. VENV (Reference only)
VENV_DIR = EXTERNAL_ROOT / "_venvs" / PROJECT_NAME

def get_path(filename, check_exists=False):
    """Smart path resolver: External > Internal"""
    external_path = DATA_DIR / filename
    local_path = BASE_DIR / filename
    
    if check_exists:
        if external_path.exists(): return external_path
        if local_path.exists(): return local_path
    
    return external_path
'''
    config_path = Path(target_path) / "config_paths.py"
    try:
        with open(config_path, "w", encoding="utf-8") as f:
            f.write(config_content)
        logger.info(f"‚úÖ [Bridge] Created {config_path.name}")
        return True
    except Exception as e:
        logger.error(f"‚ùå Failed to create config: {e}")
        return False

def restructure_project(target_path):
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞"""
    target = Path(target_path).resolve()
    project_name = target.name
    parent_dir = target.parent

    # –ù–æ–≤—ã–µ –ª–æ–∫–∞—Ü–∏–∏
    new_dirs = {
        "venv": parent_dir / "_venvs" / project_name,
        "data": parent_dir / "_data" / project_name,
        "logs": parent_dir / "_logs" / project_name
    }

    print(f"\nüèóÔ∏è  ARCHITECT: Restructuring {project_name}...")

    # 1. –°–æ–∑–¥–∞–µ–º –º–æ—Å—Ç
    create_config_paths(target, project_name)

    # 2. –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Ñ–∞–π–ª—ã
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ _data
    data_patterns = ["*.json", "*.csv", "*.db", "*.sqlite", "*.sqlite3"]
    
    for folder_type, dest_path in new_dirs.items():
        dest_path.mkdir(parents=True, exist_ok=True)

    # –ü–µ—Ä–µ–Ω–æ—Å VENV
    old_venv = target / "venv"
    if old_venv.exists():
        if new_dirs["venv"].exists():
            shutil.rmtree(new_dirs["venv"])
        print(f"üì¶ Moving venv -> {new_dirs['venv']}...")
        shutil.move(str(old_venv), str(new_dirs["venv"]))

    # –ü–µ—Ä–µ–Ω–æ—Å –ª–æ–≥–æ–≤
    for log_file in target.glob("*.log"):
        shutil.move(str(log_file), str(new_dirs["logs"] / log_file.name))
    
    if (target / "_PROJECT_LOG.md").exists():
        shutil.move(str(target / "_PROJECT_LOG.md"), str(new_dirs["logs"] / "_PROJECT_LOG.md"))

    # –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö (JSON, DB)
    for pattern in data_patterns:
        for f in target.glob(pattern):
            if f.name == "config_paths.py": continue # –ù–µ —Ç—Ä–æ–≥–∞–µ–º –Ω–∞—à –∫–æ–Ω—Ñ–∏–≥
            if "package" in str(f): continue # –ù–µ —Ç—Ä–æ–≥–∞–µ–º —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ –ª–∏–±
            
            dest = new_dirs["data"] / f.name
            print(f"üì¶ Moving data {f.name} -> {dest}")
            shutil.move(str(f), str(dest))
            
            # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –û—Å—Ç–∞–≤–ª—è–µ–º —Å–∏–º–ª–∏–Ω–∫ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É, –µ—Å–ª–∏ –±–æ–∏–º—Å—è —Å–ª–æ–º–∞—Ç—å —Å–æ–≤—Å–µ–º –≤—Å—ë?
            # –ü–æ–∫–∞ –Ω–µ—Ç, –º—ã –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ config_paths.py

    # 3. –ü–∞—Ç—á–∏–Ω–≥ .bat —Ñ–∞–π–ª–æ–≤
    fix_launch_scripts(target, project_name)
    
    # 4. –ß–∏—Å—Ç–∫–∞ .cursorignore
    update_cursor_ignore(target)

    print(f"‚ú® Architecture updated! Dependencies are now external.")

def fix_launch_scripts(target_path, project_name):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞—Ç–Ω–∏–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ venv"""
    new_python_path = f'call "..\\_venvs\\{project_name}\\Scripts\\python.exe"'
    
    for bat in target_path.glob("*.bat"):
        content = bat.read_text(encoding="utf-8", errors="ignore")
        # –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ –≤—ã–∑–æ–≤–∞ python
        if "venv\\Scripts\\activate" in content or "python main.py" in content:
            new_content = re.sub(r'call\s+venv\\Scripts\\activate', 'REM External Venv Used', content, flags=re.IGNORECASE)
            new_content = re.sub(r'python\s+main\.py', f'{new_python_path} main.py', new_content, flags=re.IGNORECASE)
            
            bat.write_text(new_content, encoding="utf-8")
            print(f"üîß Patched launch script: {bat.name}")

def update_cursor_ignore(target_path):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–≥–Ω–æ—Ä –ª–∏—Å—Ç"""
    ignore_file = target_path / ".cursorignore"
    content = """# AI-Native Architecture
# Data and Env are external

_venvs/
_data/
_logs/
__pycache__/
*.pyc
"""
    ignore_file.write_text(content, encoding="utf-8")
    print("üßπ Updated .cursorignore")

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è main.py
def run(args):
    restructure_project(args.path)